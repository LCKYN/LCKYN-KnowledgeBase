---
id: 71.03
tags: [type/code, status/growing, context/python, context/api]
---

# FastAPI

## Overview
Modern, high-performance Python web framework for building APIs with automatic documentation, type validation, and async support.

**Key Features**: High performance, type hints, auto docs (OpenAPI), async/await, dependency injection

## Installation & Basic Setup

```bash
pip install "fastapi[all]"  # Includes uvicorn server

# Run server
uvicorn main:app --reload
```

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
async def root():
    return {"message": "Hello World"}

@app.get("/items/{item_id}")
async def read_item(item_id: int, q: str | None = None):
    return {"item_id": item_id, "q": q}
```

**Access**: `http://127.0.0.1:8000` | Docs: `/docs` | ReDoc: `/redoc`

## Request/Response Patterns

### Pydantic Models
```python
from pydantic import BaseModel, Field

class Item(BaseModel):
    name: str
    price: float = Field(gt=0)
    description: str | None = None
    tags: list[str] = []

@app.post("/items/", response_model=Item, status_code=201)
async def create_item(item: Item):
    return item
```

### Path & Query Parameters
```python
from enum import Enum

class ModelType(str, Enum):
    resnet = "resnet"
    efficientnet = "efficientnet"

@app.get("/models/{model_type}")
async def get_model(model_type: ModelType, version: int = 1):
    return {"model": model_type, "version": version}
```

## Dependency Injection

```python
from fastapi import Depends
from sqlalchemy.orm import Session

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@app.get("/users/{user_id}")
async def read_user(user_id: int, db: Session = Depends(get_db)):
    return db.query(User).filter(User.id == user_id).first()
```

## Authentication

### JWT Example
```python
from fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm
from jose import jwt
from passlib.context import CryptContext
from datetime import datetime, timedelta

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")
pwd_context = CryptContext(schemes=["bcrypt"])

def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=30)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm="HS256")

@app.post("/token")
async def login(form_data: OAuth2PasswordRequestForm = Depends()):
    user = authenticate_user(form_data.username, form_data.password)
    access_token = create_access_token(data={"sub": user.username})
    return {"access_token": access_token, "token_type": "bearer"}

async def get_current_user(token: str = Depends(oauth2_scheme)):
    payload = jwt.decode(token, SECRET_KEY, algorithms=["HS256"])
    return get_user(payload.get("sub"))

@app.get("/users/me")
async def read_current_user(current_user = Depends(get_current_user)):
    return current_user
```

## Database Integration

### SQLAlchemy
```python
from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.orm import declarative_base, sessionmaker

Base = declarative_base()
engine = create_engine("sqlite:///./db.sqlite3")
SessionLocal = sessionmaker(bind=engine)

class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True)
    email = Column(String, unique=True, index=True)

Base.metadata.create_all(bind=engine)
```

### MongoDB (Async)
```python
from motor.motor_asyncio import AsyncIOMotorClient

@app.on_event("startup")
async def startup():
    app.mongodb = AsyncIOMotorClient(MONGO_URL).mydb

@app.post("/items/")
async def create_item(item: Item):
    result = await app.mongodb.items.insert_one(item.dict())
    return {"id": str(result.inserted_id)}
```

## Advanced Features

### Background Tasks
```python
from fastapi import BackgroundTasks

def send_email(email: str, message: str):
    # Email logic here
    pass

@app.post("/notify/")
async def notify(email: str, background_tasks: BackgroundTasks):
    background_tasks.add_task(send_email, email, "Notification")
    return {"message": "Email will be sent"}
```

### File Upload
```python
from fastapi import File, UploadFile

@app.post("/upload/")
async def upload(file: UploadFile = File(...)):
    contents = await file.read()
    return {"filename": file.filename, "size": len(contents)}
```

### WebSockets
```python
from fastapi import WebSocket

@app.websocket("/ws/{client_id}")
async def websocket_endpoint(websocket: WebSocket, client_id: int):
    await websocket.accept()
    while True:
        data = await websocket.receive_text()
        await websocket.send_text(f"Message: {data}")
```

### CORS
```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)
```

## Error Handling

```python
from fastapi import HTTPException

@app.get("/items/{item_id}")
async def read_item(item_id: str):
    if item_id not in items:
        raise HTTPException(status_code=404, detail="Item not found")
    return items[item_id]

# Custom exception handler
@app.exception_handler(ValueError)
async def value_error_handler(request, exc):
    return JSONResponse(status_code=400, content={"message": str(exc)})
```

## Production Deployment

### Docker
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### Multiple Workers
```bash
# Uvicorn
uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4

# Gunicorn + Uvicorn
gunicorn main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker
```

## Router Organization

```python
from fastapi import APIRouter

# users.py
router = APIRouter(prefix="/users", tags=["users"])

@router.get("/")
async def list_users():
    return []

# main.py
from routers import users
app.include_router(users.router)
```

## Testing

```python
from fastapi.testclient import TestClient

client = TestClient(app)

def test_read_root():
    response = client.get("/")
    assert response.status_code == 200
    assert response.json() == {"message": "Hello World"}
```

## Best Practices

1. **Type hints everywhere** - Better validation and IDE support
2. **Pydantic models** for request/response schemas
3. **Dependency injection** for database sessions, auth
4. **Response models** to filter sensitive data
5. **Router organization** for large apps
6. **Async for I/O** - Database queries, API calls
7. **Environment variables** for config
8. **Error handling** with HTTPException
9. **Background tasks** for non-blocking operations
10. **Auto-generated docs** are always up-to-date

## Common Use Cases

- ML/AI model serving APIs
- CRUD REST APIs with database
- Microservices architecture
- Real-time applications (WebSocket)
- File upload/processing services
- Authentication/authorization services
- FastAPI Best Practices: github.com/zhanymkanov/fastapi-best-practices
- "Building Data Science Applications with FastAPI" (Durand, 2021)
