---
id: 73.01
tags: [type/code, status/growing, context/infrastructure, context/devops]
---

# Nginx

## Overview
Nginx (pronounced "engine-x") is a high-performance HTTP server, reverse proxy, and load balancer. Known for low memory usage, high concurrency handling, and stability.

**Common Uses**: Web server, reverse proxy, load balancer, SSL termination, static file serving, API gateway

## Installation

```bash
# Ubuntu/Debian
sudo apt update && sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx

# macOS
brew install nginx

# Start/Enable
sudo systemctl start nginx
sudo systemctl enable nginx
```

## Configuration Structure

```
/etc/nginx/
├── nginx.conf              # Main config
├── sites-available/        # Available site configs
├── sites-enabled/          # Enabled sites (symlinks)
├── conf.d/                 # Additional configs
└── snippets/               # Reusable config snippets
```

## Basic Server Block

```nginx
# /etc/nginx/sites-available/example.com
server {
    listen 80;
    listen [::]:80;
    server_name example.com www.example.com;
    root /var/www/example.com;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

```bash
# Enable site
sudo ln -s /etc/nginx/sites-available/example.com /etc/nginx/sites-enabled/
sudo nginx -t  # Test config
sudo systemctl reload nginx
```

## Reverse Proxy

### Basic Proxy to Backend
```nginx
server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### FastAPI/Uvicorn Backend
```nginx
server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### WebSocket Support
```nginx
location /ws {
    proxy_pass http://localhost:8000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 86400;
}
```

## Load Balancing

```nginx
upstream backend {
    least_conn;  # or: round_robin (default), ip_hash, random
    server 127.0.0.1:8001 weight=3;
    server 127.0.0.1:8002;
    server 127.0.0.1:8003 backup;
}

server {
    listen 80;
    server_name app.example.com;

    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
    }
}
```

**Load Balancing Methods**:
- `round_robin` - Default, sequential distribution
- `least_conn` - Route to server with fewest connections
- `ip_hash` - Sticky sessions based on client IP
- `random` - Random server selection

## SSL/TLS (HTTPS)

### With Let's Encrypt (Certbot)
```bash
# Install certbot
sudo apt install certbot python3-certbot-nginx

# Get certificate and auto-configure nginx
sudo certbot --nginx -d example.com -d www.example.com

# Auto-renewal
sudo certbot renew --dry-run
```

### Manual SSL Config
```nginx
server {
    listen 443 ssl http2;
    server_name example.com;

    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;

    # Modern SSL settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;

    location / {
        proxy_pass http://localhost:8000;
    }
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}
```

## Static Files & Caching

```nginx
server {
    listen 80;
    server_name static.example.com;
    root /var/www/static;

    # Cache static assets
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript;
    gzip_min_length 1000;
}
```

## API Gateway Pattern

```nginx
server {
    listen 80;
    server_name api.example.com;

    # Auth service
    location /auth/ {
        proxy_pass http://localhost:8001/;
    }

    # Users service
    location /users/ {
        proxy_pass http://localhost:8002/;
    }

    # Products service
    location /products/ {
        proxy_pass http://localhost:8003/;
    }

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

    location /api/ {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://localhost:8000/;
    }
}
```

## Security Headers

```nginx
server {
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'" always;

    # Hide nginx version
    server_tokens off;
}
```

## Common Patterns

### SPA (React/Vue) with API
```nginx
server {
    listen 80;
    server_name app.example.com;
    root /var/www/app/dist;

    # API proxy
    location /api/ {
        proxy_pass http://localhost:8000/;
    }

    # SPA fallback
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

### File Upload Size
```nginx
server {
    client_max_body_size 100M;  # Increase upload limit

    location /upload {
        proxy_pass http://localhost:8000;
    }
}
```

### Basic Auth
```bash
# Create password file
sudo apt install apache2-utils
sudo htpasswd -c /etc/nginx/.htpasswd username
```

```nginx
location /admin {
    auth_basic "Admin Area";
    auth_basic_user_file /etc/nginx/.htpasswd;
    proxy_pass http://localhost:8000;
}
```

### IP Restriction
```nginx
location /admin {
    allow 192.168.1.0/24;
    allow 10.0.0.1;
    deny all;
    proxy_pass http://localhost:8000;
}
```

## Performance Tuning

```nginx
# /etc/nginx/nginx.conf
worker_processes auto;
worker_connections 1024;

http {
    # Buffers
    client_body_buffer_size 10K;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 32k;

    # Timeouts
    client_body_timeout 12;
    client_header_timeout 12;
    keepalive_timeout 15;
    send_timeout 10;

    # File cache
    open_file_cache max=1000 inactive=20s;
    open_file_cache_valid 30s;
}
```

## Useful Commands

```bash
nginx -t                    # Test configuration
nginx -T                    # Test and dump config
nginx -s reload             # Reload config
nginx -s stop               # Stop server
systemctl status nginx      # Check status
tail -f /var/log/nginx/error.log    # View error log
tail -f /var/log/nginx/access.log   # View access log
```

## Docker

```dockerfile
FROM nginx:alpine
COPY nginx.conf /etc/nginx/nginx.conf
COPY dist/ /usr/share/nginx/html/
EXPOSE 80
```

```yaml
# docker-compose.yml
services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
```

## Debugging Tips

1. **Test config before reload**: `nginx -t`
2. **Check error logs**: `/var/log/nginx/error.log`
3. **Verbose logging**: Set `error_log /var/log/nginx/error.log debug;`
4. **Check upstream**: `curl -I http://localhost:8000`
5. **Permission issues**: Ensure nginx user can read files

## Related Concepts
- [[73_Shell_Automation_MOC]] - Parent category
- [[71.03 FastAPI]] - Proxy FastAPI with nginx
- [[73.02 Docker]] - Deploy nginx in containers

## References
- Official Docs: nginx.org/en/docs/
- Digital Ocean Nginx Guides
- Mozilla SSL Configuration Generator
